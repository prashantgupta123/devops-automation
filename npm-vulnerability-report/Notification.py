import datetime
import smtplib
import logging
import os
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.application import MIMEApplication

logger = logging.getLogger(__name__)


def send_email(smtp_credentials, smtp_details, email_content):
    logger.info("Starting email send process")
    
    try:
        date_time_obj = datetime.datetime.now()
        format_date = date_time_obj.strftime("%d %B %Y")
        smtp_subject = smtp_details["subject_prefix"] + ' | ' + smtp_details["email_subject"] + ' | ' + format_date
        smtp_host = smtp_credentials["host"]
        smtp_port = int(smtp_credentials["port"])
        smtp_username = smtp_credentials["username"]
        smtp_password = smtp_credentials["password"]
        smtp_from = smtp_credentials["from_email"]
        smtp_to = smtp_details["to"]
        smtp_cc = smtp_details["cc"]
        smtp_bcc = smtp_details["bcc"]

        logger.info(f"SMTP Config: {smtp_host}:{smtp_port}, From: {smtp_from}, To: {smtp_to}, Cc: {smtp_cc}, Bcc: {smtp_bcc}")
        logger.debug(f"Email subject: {smtp_subject}")

        message = MIMEMultipart()
        message['Subject'] = smtp_subject
        message['From'] = smtp_from
        message['To'] = ",".join(smtp_to)
        message['Cc'] = ",".join(smtp_cc)
        message['Bcc'] = ",".join(smtp_bcc)
        part = MIMEText(email_content, 'html')
        message.attach(part)
        logger.debug("Email message composed successfully")

        # Handle multiple attachments from smtp_details
        attachments = smtp_details.get("attachments", [])
        if attachments:
            for attach_file in attachments:
                logger.info(f"Attaching file: {attach_file}")
                try:
                    with open(attach_file, 'rb') as f:
                        part = MIMEApplication(f.read())
                    filename = os.path.basename(attach_file)
                    part.add_header('Content-Disposition', 'attachment', filename=filename)
                    message.attach(part)
                    logger.info(f"File {filename} attached successfully")
                except Exception as e:
                    logger.error(f"Failed to attach file {attach_file}: {str(e)}")
                    raise

        logger.info("Connecting to SMTP server")
        server = smtplib.SMTP(smtp_host, smtp_port, timeout=30)
        logger.debug("SMTP connection established")
        
        try:
            server.starttls()
            logger.debug("STARTTLS enabled")
            
            if smtp_username is not None and smtp_username:
                logger.debug("Authenticating with SMTP server")
                server.login(smtp_username, smtp_password)
                logger.info("SMTP authentication successful")
            
            # Ensure recipient lists are properly formatted
            all_recipients = []
            if isinstance(smtp_to, list):
                all_recipients.extend(smtp_to)
            elif smtp_to:
                all_recipients.append(smtp_to)
            
            if isinstance(smtp_cc, list):
                all_recipients.extend(smtp_cc)
            elif smtp_cc:
                all_recipients.append(smtp_cc)
                
            if isinstance(smtp_bcc, list):
                all_recipients.extend(smtp_bcc)
            elif smtp_bcc:
                all_recipients.append(smtp_bcc)
            
            if not all_recipients:
                raise ValueError("No valid recipients found")
            
            logger.info("Sending email")
            server.sendmail(smtp_from, all_recipients, message.as_string())
            logger.info("Email sent successfully")
        finally:
            server.quit()
            logger.debug("SMTP connection closed")
        
    except smtplib.SMTPException as e:
        logger.error(f"SMTP error occurred: {str(e)}")
        raise
    except Exception as e:
        logger.error(f"Failed to send email: {str(e)}")
        raise
