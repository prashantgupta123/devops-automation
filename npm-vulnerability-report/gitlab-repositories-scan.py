import json
import requests
import subprocess
import os
import tempfile
import shutil
import glob
import zipfile
from Notification import send_email

def scan_frontend_repositories():
    with open('repositories.json', 'r') as f:
        projects = json.load(f)
    
    gitlab_protocol = "https"
    gitlab_domain = "gitlab.com"
    gitlab_token = os.getenv('GITLAB_TOKEN', '')
    gitlab_api = "{}://{}/api/v4".format(gitlab_protocol, gitlab_domain)
    headers = {"Authorization": "Bearer {}".format(gitlab_token)}
    branches = ['master', 'main']
    docker_image = "node:24-alpine"
    
    for project_name, project_data in projects.items():
        for repo_url in project_data['repositories']:
            # Extract project path from URL
            project_path = repo_url.replace("{}://{}/".format(gitlab_protocol, gitlab_domain), '').replace('.git', '')
            encoded_path = project_path.replace('/', '%2F')

            # Check if package.json and package-lock.json exist in any of the branches
            package_json_exists = False
            package_lock_exists = False
            
            for branch in branches:
                if not package_json_exists:
                    package_json_url = f"{gitlab_api}/projects/{encoded_path}/repository/files/package.json/raw?ref={branch}"
                    package_lock_url = f"{gitlab_api}/projects/{encoded_path}/repository/files/package-lock.json/raw?ref={branch}"
                    
                    package_json_exists = requests.get(package_json_url, headers=headers).status_code == 200
                    package_lock_exists = requests.get(package_lock_url, headers=headers).status_code == 200
            
            if package_json_exists:
                print(f"Frontend app detected: {project_name} - {repo_url}")
                
                # Clone repository temporarily
                with tempfile.TemporaryDirectory() as temp_dir:
                    clone_url = repo_url.replace("{}://{}/".format(gitlab_protocol, gitlab_domain), "https://oauth2:{}@{}/".format(gitlab_token, gitlab_domain))
                    subprocess.run(['git', 'clone', clone_url, temp_dir], capture_output=True)
                    
                    # Run npm install if package-lock.json doesn't exist, then npm audit
                    if package_lock_exists:
                        audit_cmd = f'docker run --rm -v "{temp_dir}:/app" -w /app {docker_image} sh -c "npm install -g npm@latest; npm audit --json >> npm-audit.json || true"'
                    else:
                        audit_cmd = f'docker run --rm -v "{temp_dir}:/app" -w /app {docker_image} sh -c "npm install -g npm@latest; npm install || true; npm audit --json >> npm-audit.json || true"'
                    subprocess.run(audit_cmd, shell=True, cwd=temp_dir)
                    
                    # Create project directory structure
                    project_dir = os.path.join('projects', project_name)
                    os.makedirs(project_dir, exist_ok=True)
                    
                    # Copy audit result to project directory
                    audit_file = os.path.join(temp_dir, 'npm-audit.json')
                    if os.path.exists(audit_file):
                        repo_name = repo_url.split('/')[-1].replace('.git', '')
                        dest_file = os.path.join(project_dir, f"{repo_name}_npm-audit.json")
                        shutil.copy(audit_file, dest_file)
                        print(f"Audit completed: {dest_file}")

def generate_email_report():
    with open('repositories.json', 'r') as f:
        projects = json.load(f)
    
    SEVERITY_LEVELS = ["info", "low", "moderate", "high", "critical"]
    report_data = []
    
    for project_name, project_data in projects.items():
        project_dir = os.path.join('projects', project_name)
        if os.path.exists(project_dir):
            for audit_file in glob.glob(os.path.join(project_dir, '*_npm-audit.json')):
                repo_name = os.path.basename(audit_file).replace('_npm-audit.json', '')
                
                try:
                    with open(audit_file, 'r') as f:
                        audit_data = json.load(f)
                    
                    vulnerabilities = audit_data.get('metadata', {}).get('vulnerabilities', {})
                    
                    report_data.append({
                        'project': project_name,
                        'owner': project_data['data']['owner_name'],
                        'email': project_data['data']['owner_email'],
                        'repository': repo_name,
                        'vulnerabilities': {level: vulnerabilities.get(level, 0) for level in SEVERITY_LEVELS}
                    })
                except:
                    continue
    
    # Generate HTML email
    html = f"""
    <html>
    <head>
        <style>
            body {{ font-family: Arial, sans-serif; margin: 20px; }}
            .header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; }}
            .summary {{ background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0; }}
            table {{ border-collapse: collapse; width: 100%; margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #dee2e6; }}
            th {{ background: #343a40; color: white; padding: 12px; text-align: center; border: 1px solid #495057; }}
            td {{ padding: 10px; text-align: center; border: 1px solid #dee2e6; }}
            .critical {{ background: #dc3545; color: white; font-weight: bold; }}
            .high {{ background: #fd7e14; color: white; font-weight: bold; }}
            .moderate {{ background: #ffc107; color: black; font-weight: bold; }}
            .low {{ background: #28a745; color: white; }}
            .info {{ background: #17a2b8; color: white; }}
            .recommendations {{ background: #e9ecef; padding: 15px; border-radius: 5px; margin: 20px 0; }}
        </style>
    </head>
    <body>
        <div class="header">
            <h1>üîí Frontend Vulnerabilities Audit Report</h1>
            <p>Comprehensive vulnerability assessment for all frontend repositories</p>
        </div>
        
        <div class="summary">
            <h3>üìä Summary</h3>
            <p>Total repositories scanned: <strong>{len(report_data)}</strong></p>
        </div>
        
        <table>
            <tr>
                <th>Project</th><th>Owner</th><th>Repository</th>
                <th class="info">Info</th><th class="low">Low</th><th class="moderate">Moderate</th>
                <th class="high">High</th><th class="critical">Critical</th>
            </tr>
    """
    
    for item in report_data:
        v = item['vulnerabilities']
        critical_class = 'critical' if v['critical'] > 0 else ''
        high_class = 'high' if v['high'] > 0 else ''
        moderate_class = 'moderate' if v['moderate'] > 0 else ''
        low_class = 'low' if v['low'] > 0 else ''
        info_class = 'info' if v['info'] > 0 else ''
        
        html += f"""
            <tr>
                <td>{item['project']}</td>
                <td>{item['owner']}</td>
                <td>{item['repository']}</td>
                <td class="{info_class}">{v['info']}</td>
                <td class="{low_class}">{v['low']}</td>
                <td class="{moderate_class}">{v['moderate']}</td>
                <td class="{high_class}">{v['high']}</td>
                <td class="{critical_class}">{v['critical']}</td>
            </tr>
        """
    
    html += """
        </table>
        
        <div class="recommendations">
            <h3>üõ°Ô∏è Security Recommendations</h3>
            <ul>
                <li><strong>Critical & High:</strong> Address immediately - these vulnerabilities pose significant security risks</li>
                <li><strong>Moderate:</strong> Plan fixes in next sprint - potential security impact</li>
                <li><strong>Low & Info:</strong> Address during regular maintenance cycles</li>
                <li><strong>Best Practices:</strong>
                    <ul>
                        <li>Run <code>npm audit fix</code> to automatically fix vulnerabilities</li>
                        <li>Keep dependencies updated regularly</li>
                        <li>Use <code>npm audit</code> in CI/CD pipelines</li>
                        <li>Consider using tools like Snyk or Dependabot for automated monitoring</li>
                    </ul>
                </li>
            </ul>
        </div>
        
        <div style="text-align: center; margin-top: 30px; color: #6c757d;">
            <p>üìé Detailed audit files are attached for further analysis</p>
        </div>
    </body>
    </html>
    """
    
    # Create attachments
    shutil.copy('repositories.json', 'project-repositories.json')
    
    with zipfile.ZipFile('projects.zip', 'w', zipfile.ZIP_DEFLATED) as zipf:
        for root, dirs, files in os.walk('projects'):
            for file in files:
                zipf.write(os.path.join(root, file))
    
    # Send email using Notification.py
    with open('input.json', 'r') as f:
        config = json.load(f)
    
    # Collect unique owner emails for CC
    owner_emails = list(set([item['email'] for item in report_data]))
    
    email_config = config['notification']['email'].copy()
    email_config['attachments'] = ['project-repositories.json', 'projects.zip']
    email_config["to"] = owner_emails
    
    send_email(
        smtp_credentials=config['smtpCredentials'],
        smtp_details=email_config,
        email_subject='Frontend Vulnerabilities Audit Report',
        email_content=html
    )
    
    print("Email report sent successfully")
    return html

if __name__ == "__main__":
    # scan_frontend_repositories()
    generate_email_report()
