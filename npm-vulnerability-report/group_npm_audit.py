#!/usr/bin/env python3

import datetime
import json
import sys
from pathlib import Path
from typing import Dict, List, Any

# Local notification module
try:
	from Notification import send_email
except Exception:  # pragma: no cover - fallback if import path differs
	send_email = None

SEVERITY_LEVELS = ["info", "low", "moderate", "high", "critical"]
SEVERITY_RANK = {name: rank for rank, name in enumerate(SEVERITY_LEVELS)}


def load_audit_report(audit_path: Path) -> Dict[str, Any]:
	with audit_path.open("r", encoding="utf-8") as f:
		return json.load(f)


def has_vulnerabilities(report: Dict[str, Any]) -> bool:
	metadata = report.get("metadata", {})
	vuln_meta = metadata.get("vulnerabilities", {})
	total = vuln_meta.get("total", 0)
	return isinstance(total, int) and total > 0


def group_packages_by_severity(report: Dict[str, Any]) -> Dict[str, List[str]]:
	vulns = report.get("vulnerabilities", {})
	# Track highest severity seen per package name
	package_to_severity_rank: Dict[str, int] = {}
	for key, entry in vulns.items():
		name = entry.get("name", key)
		severity = entry.get("severity", "info").lower()
		if severity not in SEVERITY_RANK:
			continue
		current_rank = SEVERITY_RANK[severity]
		prev_rank = package_to_severity_rank.get(name)
		if prev_rank is None or current_rank > prev_rank:
			package_to_severity_rank[name] = current_rank

	grouped: Dict[str, List[str]] = {level: [] for level in SEVERITY_LEVELS}
	for pkg, rank in package_to_severity_rank.items():
		level = SEVERITY_LEVELS[rank]
		grouped[level].append(pkg)

	# Sort package lists for stable output
	for level in SEVERITY_LEVELS:
		grouped[level].sort()
	return grouped


def main(argv: List[str]) -> int:
	# Package Lock file path
	package_lock_path = Path("package-lock.json")
	
	# Default input path is ./npm-audit.json; allow overriding via first arg
	input_path = Path(argv[1]) if len(argv) > 1 else Path("npm-audit.json")
	# Optional: path to config file (input.json) as second arg
	config_path = Path(argv[2]) if len(argv) > 2 else Path("input.json")
	if not input_path.exists():
		print(f"Error: file not found: {input_path}", file=sys.stderr)
		return 2

	report = load_audit_report(input_path)
	metadata = report.get("metadata", {})
	vuln_counts = metadata.get("vulnerabilities", {})
	if not has_vulnerabilities(report):
		# Print empty grouping structure to be machine-readable
		empty = {level: [] for level in SEVERITY_LEVELS}
		print(json.dumps({
			"hasVulnerabilities": False,
			"groupedPackages": empty,
			"counts": vuln_counts
		}, indent=4))
		return 0

	grouped = group_packages_by_severity(report)
	result_obj = {
		"hasVulnerabilities": True,
		"groupedPackages": grouped,
		"counts": vuln_counts
	}

	# Print JSON result to stdout
	print(json.dumps(result_obj, indent=4))

	# If email support available and config exists, send HTML report
	if send_email is not None and config_path.exists():
		try:
			with config_path.open("r", encoding="utf-8") as f:
				config = json.load(f)
				smtp_credentials = config.get("smtpCredentials", {})
				notif = config.get("notification", {}).get("email", {})

				# Build HTML body
				html = []
				html.append("<!DOCTYPE html>")
				html.append("<html><head><meta charset=\"utf-8\"><style>")
				html.append("body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;color:#1f2937;margin:0;padding:0;background:#f9fafb}")
				html.append(".container{max-width:800px;margin:0 auto;background:#fff;box-shadow:0 4px 6px rgba(0,0,0,0.1)}")
				html.append(".header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:24px;text-align:center}")
				html.append(".header h1{font-size:28px;margin:0;font-weight:300}")
				html.append(".header .subtitle{font-size:14px;opacity:0.9;margin-top:8px}")
				html.append(".content{padding:24px}")
				html.append(".summary-card{background:#f8fafc;border-left:4px solid #3b82f6;padding:16px;margin-bottom:24px;border-radius:0 8px 8px 0}")
				html.append(".summary-grid{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;justify-content:space-between}")
				html.append(".summary-item{text-align:center;padding:12px;background:#fff;border-radius:8px;border:1px solid #e5e7eb;flex:1;min-width:100px;max-width:140px}")
				html.append(".summary-count{font-size:24px;font-weight:700;margin-bottom:4px}")
				html.append(".summary-label{font-size:12px;text-transform:uppercase;letter-spacing:0.5px}")
				html.append("h2{font-size:20px;margin:32px 0 16px;padding-bottom:8px;border-bottom:2px solid #e5e7eb}")
				html.append("table{border-collapse:collapse;width:100%;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.1)}")
				html.append("th,td{padding:12px 16px;text-align:left;font-size:14px}")
				html.append("th{background:#f8fafc;font-weight:600;color:#374151;border-bottom:2px solid #e5e7eb}")
				html.append("td{border-bottom:1px solid #f3f4f6}")
				html.append("tr:hover{background:#f9fafb}")
				html.append(".sev-info{color:#2563eb}.sev-low{color:#059669}.sev-moderate{color:#d97706}.sev-high{color:#dc2626}.sev-critical{color:#991b1b;font-weight:700}")
				html.append(".sev-info .summary-count{color:#2563eb}.sev-low .summary-count{color:#059669}.sev-moderate .summary-count{color:#d97706}.sev-high .summary-count{color:#dc2626}.sev-critical .summary-count{color:#991b1b}")
				html.append(".recommendations{background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:20px;margin:24px 0}")
				html.append(".recommendations h3{color:#92400e;margin:0 0 12px;font-size:18px}")
				html.append(".recommendations ul{margin:8px 0;padding-left:20px}")
				html.append(".recommendations li{margin-bottom:8px;color:#78350f}")
				html.append(".footer{background:#f3f4f6;padding:16px 24px;text-align:center;color:#6b7280;font-size:12px;border-top:1px solid #e5e7eb}")
				html.append(".badge{display:inline-block;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;text-transform:uppercase}")
				html.append(".badge-critical{background:#fef2f2;color:#991b1b}.badge-high{background:#fef2f2;color:#dc2626}.badge-moderate{background:#fffbeb;color:#d97706}.badge-low{background:#f0fdf4;color:#059669}.badge-info{background:#eff6ff;color:#2563eb}")
				html.append("</style></head><body>")
				html.append("<div class=\"container\">")
				html.append("<div class=\"header\">")
				html.append("<h1>üîí NPM Security Audit Report</h1>")
				html.append(f"<div class=\"subtitle\">Generated on {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')} | Total Vulnerabilities: {vuln_counts.get('total', 0)}</div>")
				html.append("</div>")
				html.append("<div class=\"content\">")
				
				# Summary section
				html.append("<div class=\"summary-card\">")
				html.append("<h3 style=\"margin:0 0 12px;color:#1f2937\">üìä Vulnerability Summary</h3>")
				html.append("<div class=\"summary-grid\">")
				for sev in SEVERITY_LEVELS:
					val = vuln_counts.get(sev, 0)
					html.append(f"<div class=\"summary-item sev-{sev}\">")
					html.append(f"<div class=\"summary-count\">{val}</div>")
					html.append(f"<div class=\"summary-label\">{sev}</div>")
					html.append("</div>")
				html.append("</div></div>")

				# Recommendations section
				total_vulns = vuln_counts.get('total', 0)
				critical_count = vuln_counts.get('critical', 0)
				high_count = vuln_counts.get('high', 0)
				
				if total_vulns > 0:
					html.append("<div class=\"recommendations\">")
					html.append("<h3>‚ö†Ô∏è Immediate Actions Required</h3>")
					html.append("<ul>")
					if critical_count > 0:
						html.append(f"<li><strong>URGENT:</strong> {critical_count} critical vulnerabilities found. Update immediately!</li>")
					if high_count > 0:
						html.append(f"<li><strong>HIGH PRIORITY:</strong> {high_count} high-severity issues require attention.</li>")
					html.append("<li>Run <code>npm audit fix</code> to automatically fix compatible issues</li>")
					html.append("<li>For manual fixes, run <code>npm audit fix --force</code> (review changes carefully)</li>")
					html.append("<li>Consider updating to latest package versions: <code>npm update</code></li>")
					html.append("<li>Review and update your package-lock.json after fixes</li>")
					if total_vulns > 10:
						html.append("<li>Consider implementing automated security scanning in your CI/CD pipeline</li>")
					html.append("</ul></div>")

				# Detailed tables per severity (descending order)
				for sev in reversed(SEVERITY_LEVELS):
					pkgs = grouped.get(sev, [])
					if pkgs:  # Only show sections with vulnerabilities
						badge_class = f"badge badge-{sev}"
						html.append(f"<h2 class=\"sev-{sev}\">")
						html.append(f"<span class=\"{badge_class}\">{sev}</span> ")
						html.append(f"Vulnerabilities ({len(pkgs)} packages)")
						html.append("</h2>")
						html.append("<table>")
						html.append("<thead><tr><th>üì¶ Package Name</th><th>üîß Action</th></tr></thead><tbody>")
						for p in pkgs:
							action = "Update immediately" if sev in ['critical', 'high'] else "Schedule update"
							html.append(f"<tr><td>{p}</td><td>{action}</td></tr>")
						html.append("</tbody></table>")

				html.append("</div>")
				html.append("<div class=\"footer\">")
				html.append("üìé Attachments: npm-audit.json (vulnerability details) & package-lock.json (dependency tree) | ")
				html.append("üîó Learn more: <a href=\"https://docs.npmjs.com/auditing-package-dependencies-for-security-vulnerabilities\">NPM Audit Documentation</a>")
				html.append("</div></div>")
				html.append("</body></html>")
				email_html = "".join(html)

				if send_email:
					# Prepare attachment files list
					attachment_files = [str(input_path)]
					if package_lock_path.exists():
						attachment_files.append(str(package_lock_path))
					
					# Send email with attachments
					smtp_details = {
						"email_subject": notif.get("email_subject", "NPM Vulnerability Report"),
						"subject_prefix": notif.get("subject_prefix", "Example | "),
						"to": notif.get("to", []),
						"cc": notif.get("cc", []),
						"bcc": notif.get("bcc", []),
						"attachments": attachment_files
					}
					send_email(
						smtp_credentials=smtp_credentials,
						smtp_details=smtp_details,
						email_content=email_html
					)
		except Exception as e:
			print(f"Warning: failed to send email: {e}", file=sys.stderr)

	return 0


if __name__ == "__main__":
	sys.exit(main(sys.argv))
