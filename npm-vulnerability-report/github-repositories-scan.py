import json
import requests
import subprocess
import os
import tempfile
import shutil
import glob
import zipfile
import logging
from Notification import send_email

# Configure logging
logging.basicConfig(level=logging.DEBUG, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

def scan_frontend_repositories():
    logger.info("Starting frontend repositories scan")
    
    try:
        with open('repositories.json', 'r') as f:
            projects = json.load(f)
        logger.info(f"Loaded {len(projects)} projects from repositories.json")
    except FileNotFoundError:
        logger.error("repositories.json file not found")
        return
    except json.JSONDecodeError as e:
        logger.error(f"Invalid JSON in repositories.json: {e}")
        return
    
    gitlab_protocol = "https"
    gitlab_domain = "api.github.com"
    gitlab_token = os.getenv('GITHUB_TOKEN', '')
    
    if not gitlab_token:
        logger.warning("No GitHub token found. API calls will be rate-limited. Set GITHUB_TOKEN environment variable.")
    
    gitlab_api = f"{gitlab_protocol}://{gitlab_domain}"
    headers = {"Authorization": f"token {gitlab_token}"} if gitlab_token else {}
    branches = ['master', 'main']
    docker_image = "node:24-alpine"
    
    scanned_count = 0
    frontend_count = 0
    
    for project_name, project_data in projects.items():
        logger.info(f"Processing project: {project_name}")
        
        for repo_url in project_data['repositories']:
            scanned_count += 1
            logger.info(f"Scanning repository: {repo_url}")
            
            try:
                # Extract project path from URL
                project_path = repo_url.replace(f"{gitlab_protocol}://github.com/", '').replace('.git', '')
                owner, repo = project_path.split('/')
                logger.info(f"Repository details - Owner: {owner}, Repo: {repo}")

                # Check if package.json and package-lock.json exist in any of the branches
                package_json_exists = False
                package_lock_exists = False
                
                for branch in branches:
                    if not package_json_exists:
                        package_json_url = f"{gitlab_api}/repos/{owner}/{repo}/contents/package.json?ref={branch}"
                        package_lock_url = f"{gitlab_api}/repos/{owner}/{repo}/contents/package-lock.json?ref={branch}"
                        
                        logger.info(f"Checking branch '{branch}' for package.json")
                        
                        try:
                            package_json_response = requests.get(package_json_url, headers=headers)
                            package_lock_response = requests.get(package_lock_url, headers=headers)
                            
                            logger.info(f"package.json check - Status: {package_json_response.status_code}")
                            logger.info(f"package-lock.json check - Status: {package_lock_response.status_code}")
                            
                            package_json_exists = package_json_response.status_code == 200
                            package_lock_exists = package_lock_response.status_code == 200
                            
                            if package_json_exists:
                                logger.info(f"Found package.json in branch '{branch}'")
                                break
                                
                        except requests.RequestException as e:
                            logger.error(f"API request failed for {repo_url}: {e}")
                            continue
                
                if package_json_exists:
                    frontend_count += 1
                    logger.info(f"Frontend app detected: {project_name} - {repo_url}")
                    
                    # Clone repository temporarily
                    with tempfile.TemporaryDirectory() as temp_dir:
                        logger.info(f"Created temporary directory: {temp_dir}")
                        
                        # Clone without token in URL for public repos, or use token if available
                        if gitlab_token:
                            clone_url = repo_url.replace("https://github.com/", f"https://{gitlab_token}@github.com/")
                        else:
                            clone_url = repo_url
                            
                        logger.info(f"Cloning repository to {temp_dir}")
                        clone_result = subprocess.run(['git', 'clone', clone_url, temp_dir], 
                                                    capture_output=True, text=True)
                        
                        if clone_result.returncode != 0:
                            logger.error(f"Git clone failed: {clone_result.stderr}")
                            continue
                        
                        logger.info("Repository cloned successfully")
                        
                        # Verify package.json exists in cloned repo
                        package_json_path = os.path.join(temp_dir, 'package.json')
                        if not os.path.exists(package_json_path):
                            logger.error(f"package.json not found in cloned repo: {package_json_path}")
                            continue
                        
                        logger.info("package.json verified in cloned repository")
                        
                        # Run npm install if package-lock.json doesn't exist, then npm audit
                        if package_lock_exists:
                            audit_cmd = f'docker run --rm -v "{temp_dir}:/app" -w /app {docker_image} sh -c "npm install -g npm@latest && npm audit --json > npm-audit.json"'
                        else:
                            audit_cmd = f'docker run --rm -v "{temp_dir}:/app" -w /app {docker_image} sh -c "npm install -g npm@latest && npm install && npm audit --json > npm-audit.json"'
                        
                        logger.info(f"Running Docker command: {audit_cmd}")
                        audit_result = subprocess.run(audit_cmd, shell=True, cwd=temp_dir, 
                                                    capture_output=True, text=True)
                        
                        logger.info(f"Docker command exit code: {audit_result.returncode}")
                        if audit_result.stderr:
                            logger.warning(f"Docker stderr: {audit_result.stderr}")
                        if audit_result.stdout:
                            logger.info(f"Docker stdout: {audit_result.stdout[:500]}...")  # First 500 chars
                        
                        # Create project directory structure
                        project_dir = os.path.join('projects', project_name)
                        os.makedirs(project_dir, exist_ok=True)
                        logger.info(f"Created project directory: {project_dir}")
                        
                        # Copy audit result to project directory
                        audit_file = os.path.join(temp_dir, 'npm-audit.json')
                        if os.path.exists(audit_file):
                            repo_name = repo_url.split('/')[-1].replace('.git', '')
                            dest_file = os.path.join(project_dir, f"{repo_name}_npm-audit.json")
                            shutil.copy(audit_file, dest_file)
                            
                            # Verify file was copied and has content
                            if os.path.exists(dest_file):
                                file_size = os.path.getsize(dest_file)
                                logger.info(f"Audit completed: {dest_file} (Size: {file_size} bytes)")
                                
                                # Log first few lines of audit file for verification
                                try:
                                    with open(dest_file, 'r') as f:
                                        content = f.read(200)
                                        logger.info(f"Audit file preview: {content}...")
                                except Exception as e:
                                    logger.error(f"Could not read audit file: {e}")
                            else:
                                logger.error(f"Failed to copy audit file to {dest_file}")
                        else:
                            logger.error(f"npm-audit.json not found at {audit_file}")
                            # List files in temp_dir for debugging
                            try:
                                files = os.listdir(temp_dir)
                                logger.info(f"Files in temp directory: {files}")
                            except Exception as e:
                                logger.error(f"Could not list temp directory: {e}")
                else:
                    logger.info(f"No package.json found in repository: {repo_url}")
                    
            except Exception as e:
                logger.error(f"Error processing repository {repo_url}: {e}")
                continue
    
    logger.info(f"Scan completed. Total repositories: {scanned_count}, Frontend apps: {frontend_count}")

def generate_email_report():
    logger.info("Starting email report generation")
    
    try:
        with open('repositories.json', 'r') as f:
            projects = json.load(f)
        logger.info(f"Loaded {len(projects)} projects for report generation")
    except FileNotFoundError:
        logger.error("repositories.json file not found")
        return
    except json.JSONDecodeError as e:
        logger.error(f"Invalid JSON in repositories.json: {e}")
        return
    
    SEVERITY_LEVELS = ["info", "low", "moderate", "high", "critical"]
    report_data = []
    
    # Check if projects directory exists
    if not os.path.exists('projects'):
        logger.error("Projects directory not found. Run scan_frontend_repositories() first.")
        return
    
    logger.info("Scanning projects directory for audit files")
    
    for project_name, project_data in projects.items():
        project_dir = os.path.join('projects', project_name)
        logger.info(f"Checking project directory: {project_dir}")
        
        if os.path.exists(project_dir):
            audit_files = glob.glob(os.path.join(project_dir, '*_npm-audit.json'))
            logger.info(f"Found {len(audit_files)} audit files in {project_dir}")
            
            for audit_file in audit_files:
                repo_name = os.path.basename(audit_file).replace('_npm-audit.json', '')
                logger.info(f"Processing audit file: {audit_file}")
                
                try:
                    with open(audit_file, 'r') as f:
                        audit_data = json.load(f)
                    
                    vulnerabilities = audit_data.get('metadata', {}).get('vulnerabilities', {})
                    logger.info(f"Vulnerabilities found for {repo_name}: {vulnerabilities}")
                    
                    report_data.append({
                        'project': project_name,
                        'owner': project_data['data']['owner_name'],
                        'email': project_data['data']['owner_email'],
                        'repository': repo_name,
                        'vulnerabilities': {level: vulnerabilities.get(level, 0) for level in SEVERITY_LEVELS}
                    })
                except json.JSONDecodeError as e:
                    logger.error(f"Invalid JSON in audit file {audit_file}: {e}")
                    continue
                except Exception as e:
                    logger.error(f"Error processing audit file {audit_file}: {e}")
                    continue
        else:
            logger.warning(f"Project directory does not exist: {project_dir}")
    
    logger.info(f"Generated report data for {len(report_data)} repositories")
    
    # Generate HTML email
    html = f"""
    <html>
    <head>
        <style>
            body {{ font-family: Arial, sans-serif; margin: 20px; }}
            .header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; }}
            .summary {{ background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0; }}
            table {{ border-collapse: collapse; width: 100%; margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #dee2e6; }}
            th {{ background: #343a40; color: white; padding: 12px; text-align: center; border: 1px solid #495057; }}
            td {{ padding: 10px; text-align: center; border: 1px solid #dee2e6; }}
            .critical {{ background: #dc3545; color: white; font-weight: bold; }}
            .high {{ background: #fd7e14; color: white; font-weight: bold; }}
            .moderate {{ background: #ffc107; color: black; font-weight: bold; }}
            .low {{ background: #28a745; color: white; }}
            .info {{ background: #17a2b8; color: white; }}
            .recommendations {{ background: #e9ecef; padding: 15px; border-radius: 5px; margin: 20px 0; }}
        </style>
    </head>
    <body>
        <div class="header">
            <h1>üîí Frontend Vulnerabilities Audit Report</h1>
            <p>Comprehensive vulnerability assessment for all frontend repositories</p>
        </div>
        
        <div class="summary">
            <h3>üìä Summary</h3>
            <p>Total repositories scanned: <strong>{len(report_data)}</strong></p>
        </div>
        
        <table>
            <tr>
                <th>Project</th><th>Owner</th><th>Repository</th>
                <th class="info">Info</th><th class="low">Low</th><th class="moderate">Moderate</th>
                <th class="high">High</th><th class="critical">Critical</th>
            </tr>
    """
    
    for item in report_data:
        v = item['vulnerabilities']
        critical_class = 'critical' if v['critical'] > 0 else ''
        high_class = 'high' if v['high'] > 0 else ''
        moderate_class = 'moderate' if v['moderate'] > 0 else ''
        low_class = 'low' if v['low'] > 0 else ''
        info_class = 'info' if v['info'] > 0 else ''
        
        html += f"""
            <tr>
                <td>{item['project']}</td>
                <td>{item['owner']}</td>
                <td>{item['repository']}</td>
                <td class="{info_class}">{v['info']}</td>
                <td class="{low_class}">{v['low']}</td>
                <td class="{moderate_class}">{v['moderate']}</td>
                <td class="{high_class}">{v['high']}</td>
                <td class="{critical_class}">{v['critical']}</td>
            </tr>
        """
    
    html += """
        </table>
        
        <div class="recommendations">
            <h3>üõ°Ô∏è Security Recommendations</h3>
            <ul>
                <li><strong>Critical & High:</strong> Address immediately - these vulnerabilities pose significant security risks</li>
                <li><strong>Moderate:</strong> Plan fixes in next sprint - potential security impact</li>
                <li><strong>Low & Info:</strong> Address during regular maintenance cycles</li>
                <li><strong>Best Practices:</strong>
                    <ul>
                        <li>Run <code>npm audit fix</code> to automatically fix vulnerabilities</li>
                        <li>Keep dependencies updated regularly</li>
                        <li>Use <code>npm audit</code> in CI/CD pipelines</li>
                        <li>Consider using tools like Snyk or Dependabot for automated monitoring</li>
                    </ul>
                </li>
            </ul>
        </div>
        
        <div style="text-align: center; margin-top: 30px; color: #6c757d;">
            <p>üìé Detailed audit files are attached for further analysis</p>
        </div>
    </body>
    </html>
    """
    
    # Create zip file with proper logging
    logger.info("Creating projects.zip file")
    files_added = 0
    
    try:
        with zipfile.ZipFile('projects.zip', 'w', zipfile.ZIP_DEFLATED) as zipf:
            if os.path.exists('projects'):
                for root, dirs, files in os.walk('projects'):
                    for file in files:
                        file_path = os.path.join(root, file)
                        arcname = os.path.relpath(file_path, '.')
                        zipf.write(file_path, arcname)
                        files_added += 1
                        logger.info(f"Added to zip: {arcname}")
            else:
                logger.warning("Projects directory not found, creating empty zip")
        
        logger.info(f"Created projects.zip with {files_added} files")
        
        # Verify zip file
        if os.path.exists('projects.zip'):
            zip_size = os.path.getsize('projects.zip')
            logger.info(f"projects.zip created successfully (Size: {zip_size} bytes)")
        else:
            logger.error("Failed to create projects.zip")
            
    except Exception as e:
        logger.error(f"Error creating zip file: {e}")
    
    # Send email using Notification.py
    try:
        with open('input.json', 'r') as f:
            config = json.load(f)
        
        # Collect unique owner emails for CC
        owner_emails = list(set([item['email'] for item in report_data]))
        logger.info(f"Owner emails for notification: {owner_emails}")
        
        email_config = config['notification']['email'].copy()
        email_config['attachments'] = ['repositories.json', 'projects.zip']
        email_config["to"] = owner_emails
        
        send_email(
            smtp_credentials=config['smtpCredentials'],
            smtp_details=email_config,
            email_content=html
        )
        
        logger.info("Email report sent successfully")
        
    except FileNotFoundError:
        logger.error("input.json file not found")
    except Exception as e:
        logger.error(f"Error sending email: {e}")
    
    return html

def test_docker_availability():
    """Test if Docker is available and working"""
    try:
        result = subprocess.run(['docker', '--version'], capture_output=True, text=True)
        if result.returncode == 0:
            logger.info(f"Docker available: {result.stdout.strip()}")
            return True
        else:
            logger.error("Docker not available")
            return False
    except FileNotFoundError:
        logger.error("Docker command not found")
        return False

if __name__ == "__main__":
    logger.info("Starting NPM vulnerability scan")
    
    # Test Docker availability
    if not test_docker_availability():
        logger.error("Docker is required but not available. Please install Docker.")
        exit(1)
    
    # Run the scan
    scan_frontend_repositories()
    
    # Generate report
    generate_email_report()
